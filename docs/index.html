<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="color-scheme" content="dark light">
    <title>Kalah (Mancala) ‚Äî React (Responsive)</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg: #0b1220; --card:#0e1629; --muted:#9aa4b2; --ring:#334155; --txt:#e5e7eb; --acc:#22c55e; --warn:#f59e0b; --danger:#ef4444;
        --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      }
      @media (prefers-color-scheme: light){
        :root{ --bg:#f7fafc; --card:#ffffff; --txt:#0f172a; --muted:#475569; --ring:#cbd5e1; }
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, rgba(34,197,94,.12), transparent 60%), radial-gradient(1200px 800px at 110% 20%, rgba(59,130,246,.12), transparent 60%), var(--bg); color:var(--txt); font-family:Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; -webkit-tap-highlight-color: transparent}
      .wrap{max-width:1080px;margin:0 auto;padding:clamp(12px,2.5vw,28px)}
      header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
      .title{font-size:clamp(22px,3.5vw,32px);font-weight:800;letter-spacing:.2px;margin:0}
      .sub{margin:2px 0 0;color:var(--muted);font-size:clamp(12px,2.4vw,14px)}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      @media (min-width:900px){.grid{grid-template-columns:320px 1fr}}

      /* Card */
      .card{background:var(--card); border:1px solid var(--ring); border-radius:18px; padding:14px; box-shadow:var(--shadow)}
      .card h3{margin:0 0 10px;font-size:16px}

      /* Board */
      .board{display:grid; grid-template-columns: 80px 1fr 80px; gap:10px; align-items:center}
      @media (max-width:520px){ .board{grid-template-columns: 64px 1fr 64px} }

      .pits{display:grid; gap:10px; grid-template-columns: repeat(6, minmax(0,1fr));}
      .pit{position:relative; aspect-ratio:1/1; border-radius:16px; border:1px solid var(--ring); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); display:flex; flex-direction:column; justify-content:center; align-items:center; user-select:none; cursor:pointer; transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease; box-shadow:var(--shadow); touch-action:manipulation}
      .pit:active{transform:translateY(1px) scale(.995)}
      .pit.disabled{opacity:.45; cursor:not-allowed; filter:saturate(.6)}
      .pit .idx{position:absolute; top:6px; left:8px; font-size:11px; color:var(--muted)}
      .pit .val{font-weight:800; font-size:clamp(16px,3.5vw,20px)}
      .store{min-height:100%; height:100%; border-radius:16px; border:1px solid var(--ring); display:flex; flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); box-shadow:var(--shadow)}
      .store .label{font-size:12px; color:var(--muted)}
      .store .val{font-size:clamp(18px,3.8vw,22px); font-weight:800; margin-top:6px}

      /* Controls */
      .panel{display:flex;flex-wrap:wrap;gap:10px}
      .row{display:flex;gap:10px;align-items:center}
      .select,.input,button{appearance:none; background:var(--card); color:var(--txt); border:1px solid var(--ring); border-radius:12px; padding:10px 12px; font:inherit}
      .select,.input{min-width:60px}
      button{cursor:pointer; box-shadow:var(--shadow)}
      .primary{background:linear-gradient(90deg, #16a34a, #22c55e); border-color:transparent; color:#051106; font-weight:800}
      .ghost{border-style:dashed}
      .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--ring); color:var(--muted); font-size:12px}
      .status{margin-top:8px; font-weight:600}

      /* Animations */
      @media (prefers-reduced-motion: no-preference){
        .glow{position:absolute; inset:-1px; border-radius:inherit; background: radial-gradient(100% 100% at 50% 0%, rgba(34,197,94,.18), transparent 50%); filter:blur(6px); pointer-events:none}
      }

      /* Helpers */
      .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
      footer{margin-top:16px; color:var(--muted); font-size:13px}
      a.link{color:#60a5fa; text-decoration:none}
      .toast{position:fixed; bottom:12px; left:50%; transform:translateX(-50%); background:var(--card); border:1px solid var(--ring); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); font-size:14px}
      @supports(padding:max(0px)){ body{padding-bottom: max(0px, env(safe-area-inset-bottom))} }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1 class="title">Kalah (Mancala)</h1>
          <p class="sub">–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ–±‚Äë–≤–µ—Ä—Å–∏—è: –∏–¥–µ–∞–ª—å–Ω–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –ø–ª–∞–Ω—à–µ—Ç–µ –∏ –ü–ö. –ü—Ä–∞–≤–∏–ª–∞ –ö–∞–ª–∞—Ö–∞ —Å –±–æ–Ω—É—Å–Ω—ã–º —Ö–æ–¥–æ–º –∏ –∑–∞—Ö–≤–∞—Ç–æ–º.</p>
        </div>
        <div class="row" role="group" aria-label="quick actions">
          <button id="newGame" class="primary" title="–ù–æ–≤–∞—è –∏–≥—Ä–∞">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
          <button id="undo" class="ghost" title="–û—Ç–º–µ–Ω–∏—Ç—å —Ö–æ–¥ (—à–∞–≥ –Ω–∞–∑–∞–¥)">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
      </header>

      <div class="grid" aria-live="polite">
        <section class="card" aria-label="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã">
          <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <div class="panel">
            <label> –†–µ–∂–∏–º:
              <select id="aiMode" class="select">
                <option value="none">–ß–µ–ª–æ–≤–µ–∫ vs –ß–µ–ª–æ–≤–µ–∫</option>
                <option value="first">–ò–ò –∑–∞ P1 (–ø–µ—Ä–≤—ã–π)</option>
                <option value="second" selected>–ò–ò –∑–∞ P2 (–≤—Ç–æ—Ä–æ–π)</option>
                <option value="both">–ò–ò vs –ò–ò</option>
              </select>
            </label>
            <label> –ì–ª—É–±–∏–Ω–∞ –ò–ò:
              <input id="depth" class="input" type="number" min="1" max="10" value="6" />
            </label>
            <label> –õ—É–Ω–æ–∫:
              <input id="pits" class="input" type="number" min="4" max="9" value="6" />
            </label>
            <label> –ö–∞–º–Ω–µ–π:
              <input id="seeds" class="input" type="number" min="1" max="10" value="6" />
            </label>
            <button id="apply" class="ghost">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="status" id="status">–ì–æ—Ç–æ–≤–æ</div>
          <div class="badge" id="badge"><span aria-hidden>üü¢</span><span>–ò–¥—ë—Ç –∏–≥—Ä–∞</span></div>
        </section>

        <section class="card" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ">
          <div class="board" id="board" role="application" aria-roledescription="Kalah board"></div>
        </section>
      </div>

      <footer>
        –°–¥–µ–ª–∞–Ω–æ –Ω–∞ React (CDN). –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: <a class="link" href="#" id="repoLink">(—Å—Å—ã–ª–∫–∞)</a>
      </footer>
    </div>

    <div id="toast" class="toast" hidden></div>

    <!-- React –∏–∑ CDN, —á—Ç–æ–±—ã –±–µ–∑ —Å–±–æ—Ä–∫–∏ –∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ GitHub Pages -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script type="module">
      const { useMemo, useState, useEffect, useRef } = React;

      // --- Utils ---
      const vibrate = ms => { try{ navigator.vibrate?.(ms); }catch(_){} };
      const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
      const load = (k,d)=> { try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch{ return d } };

      // --- Core game logic (mirrors Python version) ---
      const makeInitial = (n=6, seeds=6) => ({ n, board: Array(2*n).fill(seeds).concat([0,0]), player: 0, terminal:false });
      const pitsRange = (st,p)=> p===0 ? [...Array(st.n).keys()] : [...Array(st.n).keys()].map(i=>i+st.n);
      const isOwnPit = (st, idx, p=st.player)=> pitsRange(st,p).includes(idx);
      const oppositeIdx = (st, idx)=> 2*st.n - 1 - idx;
      const sideEmpty = (st,p)=> pitsRange(st,p).every(i=>st.board[i]===0);
      const clone = st => ({ n: st.n, board:[...st.board], player:st.player, terminal:st.terminal });
      const legalMoves = st => pitsRange(st,st.player).filter(i=> st.board[i]>0);
      const collectRemaining = st => { const s=clone(st), n=s.n; const s0=pitsRange(s,0).reduce((a,i)=>a+s.board[i],0); const s1=pitsRange(s,1).reduce((a,i)=>a+s.board[i],0); pitsRange(s,0).forEach(i=>s.board[i]=0); pitsRange(s,1).forEach(i=>s.board[i]=0); s.board[2*n]+=s0; s.board[2*n+1]+=s1; s.terminal=true; return s; };
      const applyMove = (st, move)=>{ if(!legalMoves(st).includes(move)) throw new Error('invalid'); const s=clone(st); let stones=s.board[move]; s.board[move]=0; const n=s.n, s0=2*n, s1=2*n+1; const own=s.player===0?s0:s1, opp=s.player===0?s1:s0; let idx=move; while(stones>0){ idx=(idx+1)%(2*n+2); if(idx===opp) continue; s.board[idx]++; stones--; } const extra=(idx===own); if(!extra && isOwnPit(s,idx) && s.board[idx]===1){ const oppIdx=oppositeIdx(s,idx); if(s.board[oppIdx]>0){ const captured=s.board[oppIdx]+1; s.board[oppIdx]=0; s.board[idx]=0; s.board[own]+=captured; }} if(sideEmpty(s,0) || sideEmpty(s,1)) return [collectRemaining(s), extra]; if(!extra) s.player=1-s.player; return [s, extra]; };
      const score = st => [st.board[2*st.n], st.board[2*st.n+1]];
      const winner = st => { if(!st.terminal) return null; const [a,b]=score(st); return a===b? -1 : (a>b?0:1) };

      // --- Simple minimax ---
      const evalState=(st,pov)=>{ const n=st.n; const my=st.board[2*n+pov], op=st.board[2*n+(1-pov)]; const mySide=pitsRange(st,pov).reduce((a,i)=>a+st.board[i],0); return (my-op)*100 + Math.floor(0.2*mySide); };
      const minimax=(st,depth,pov,alpha=-1e9,beta=1e9)=>{ if(depth===0||st.terminal) return [evalState(st,pov),null]; const moves=legalMoves(st); if(moves.length===0) return [evalState(st,pov),null]; let bestMove=null; if(st.player===pov){ let best=-1e9; for(const m of moves){ const [nxt]=applyMove(st,m); const [val]=minimax(nxt,depth-1,pov,alpha,beta); if(val>best){best=val;bestMove=m} alpha=Math.max(alpha,val); if(beta<=alpha) break; } return [best,bestMove]; } else { let best=1e9; for(const m of moves){ const [nxt]=applyMove(st,m); const [val]=minimax(nxt,depth-1,pov,alpha,beta); if(val<best){best=val;bestMove=m} beta=Math.min(beta,val); if(beta<=alpha) break; } return [best,bestMove]; } };
      const chooseBestMove=(st,depth=6)=>{ const [,m]=minimax(st,depth,st.player); return m ?? legalMoves(st)[0]; };

      // --- React UI ---
      function Pit({idx,label,value,disabled,onClick}){
        return React.createElement('button', {
          className:'pit'+(disabled?' disabled':''), onClick:disabled?undefined:onClick,
          'aria-label':`–õ—É–Ω–∫–∞ ${label}, –∫–∞–º–Ω–µ–π ${value}`, title:`–õ—É–Ω–∫–∞ ${label}`,
        },
          React.createElement('span',{className:'idx'}, label),
          React.createElement('span',{className:'val'}, value),
          React.createElement('span',{className:'glow','aria-hidden':true})
        );
      }
      function Store({label,value}){
        return React.createElement('div',{className:'store', role:'img','aria-label':`${label}: ${value}`},
          React.createElement('div',{className:'label'},label),
          React.createElement('div',{className:'val'},value)
        );
      }

      function useKalah(initial){
        const [conf,setConf] = useState(()=> load('kalah_conf', initial));
        const [st,setSt] = useState(()=> load('kalah_state', makeInitial(conf.n, conf.seeds)));
        const historyRef = useRef([]);

        const reset = (override) => { const next={...conf, ...(override||{})}; setConf(next); const s=makeInitial(next.n,next.seeds); setSt(s); historyRef.current=[]; save('kalah_conf',next); save('kalah_state',s); toast('–ù–æ–≤–∞—è –∏–≥—Ä–∞'); };
        const undo = ()=>{ const h=historyRef.current; if(!h.length) return; const last=h.pop(); setSt(last); save('kalah_state', last); toast('–•–æ–¥ –æ—Ç–º–µ–Ω—ë–Ω'); };

        const isHumanToMove = (s) => {
          const ai=conf.ai; if(ai==='none') return true; if(ai==='both') return false; if(ai==='first' && s.player===0) return false; if(ai==='second' && s.player===1) return false; return true;
        };

        const step = (cur, i)=>{ try{ historyRef.current.push(cur); const [nxt, extra]=applyMove(cur,i); setSt(nxt); save('kalah_state',nxt); vibrate(10); if(!nxt.terminal){ if(!extra && !isHumanToMove(nxt)) think(nxt); if(extra && !isHumanToMove(nxt)) think(nxt); } }catch(_){} };
        const think = (cur)=>{ setTimeout(()=>{ const m=chooseBestMove(cur, conf.depth); const [nxt, extra]=applyMove(cur,m); setSt(nxt); save('kalah_state',nxt); if(!nxt.terminal && (extra || !isHumanToMove(nxt))) think(nxt); }, 80); };

        useEffect(()=>{ if(!isHumanToMove(st)) think(st); /* on mount */ }, []);
        return { st, conf, setConf, reset, undo, step, isHumanToMove };
      }

      function Board({st, onPit}){
        const n=st.n; const legal=new Set(legalMoves(st));
        const top = st.board.slice(n,2*n).slice().reverse();
        const bottom = st.board.slice(0,n);
        const [s0,s1] = score(st);
        const status = st.terminal ? (winner(st)===-1?'–ù–∏—á—å—è':`–ü–æ–±–µ–¥–∏–ª –ò–≥—Ä–æ–∫ ${winner(st)+1}`) : `–•–æ–¥–∏—Ç –ò–≥—Ä–æ–∫ ${st.player+1}`;

        useEffect(()=>{ const el=document.getElementById('status'); el.textContent=status; document.getElementById('badge').innerHTML = st.terminal? 'üèÅ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞' : (st.player===0? 'üü¢ –•–æ–¥ P1' : 'üîµ –•–æ–¥ P2'); }, [st, status]);

        return React.createElement(React.Fragment, null,
          React.createElement('div', {className:'board'},
            React.createElement(Store,{label:'–°–∫–ª–∞–¥ P2', value:s1}),
            React.createElement('div',{className:'pits'},
              top.map((v,i)=>{ const idx=(n+(n-1-i)); const disabled=!legal.has(idx) || st.terminal; return React.createElement(Pit,{key:'t'+i, idx, label:(n-i), value:v, disabled, onClick:()=>onPit(idx)}); })
            ),
            React.createElement('div')
          ),
          React.createElement('div', {className:'board', style:{marginTop:10}},
            React.createElement('div'),
            React.createElement('div',{className:'pits'},
              bottom.map((v,i)=>{ const idx=i; const disabled=!legal.has(idx) || st.terminal; return React.createElement(Pit,{key:'b'+i, idx, label:(i+1), value:v, disabled, onClick:()=>onPit(idx)}); })
            ),
            React.createElement(Store,{label:'–°–∫–ª–∞–¥ P1', value:s0})
          )
        );
      }

      function App(){
        const { st, conf, setConf, reset, undo, step, isHumanToMove } = useKalah({ ai:'second', depth:6, n:6, seeds:6 });
        return React.createElement(React.Fragment, null,
          React.createElement(Board, { st, onPit:(i)=>{ if(isHumanToMove(st)) step(st, i); } }),
          React.createElement('div', { className:'sr-only', 'aria-live':'polite' }, st.terminal? '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞' : `–•–æ–¥–∏—Ç –∏–≥—Ä–æ–∫ ${st.player+1}`),
          React.createElement('script', {dangerouslySetInnerHTML:{__html:''}})
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('board'));
      function mount(){ root.render(React.createElement(App)); }
      mount();

      // Controls
      const elAi = document.getElementById('aiMode');
      const elDepth = document.getElementById('depth');
      const elPits = document.getElementById('pits');
      const elSeeds = document.getElementById('seeds');
      const elApply = document.getElementById('apply');
      const elNew = document.getElementById('newGame');
      const elUndo = document.getElementById('undo');
      function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.hidden=false; clearTimeout(window.__toast); window.__toast=setTimeout(()=> t.hidden=true, 1400); }
      window.toast = toast;

      // keep inputs in sync with localStorage if present
      const conf = JSON.parse(localStorage.getItem('kalah_conf') || '{}');
      if(conf.ai) elAi.value = conf.ai;
      if(conf.depth) elDepth.value = conf.depth;
      if(conf.n) elPits.value = conf.n;
      if(conf.seeds) elSeeds.value = conf.seeds;

      elApply.addEventListener('click', ()=>{ localStorage.removeItem('kalah_state'); const next={ ai:elAi.value, depth:parseInt(elDepth.value||'6',10), n:parseInt(elPits.value||'6',10), seeds:parseInt(elSeeds.value||'6',10) }; localStorage.setItem('kalah_conf', JSON.stringify(next)); location.reload(); });
      elNew.addEventListener('click', ()=>{ localStorage.removeItem('kalah_state'); toast('–ù–æ–≤–∞—è –∏–≥—Ä–∞'); location.reload(); });
      elUndo.addEventListener('click', ()=>{ window.undo?.(); });

      // Expose undo via global (hook is inside React)
      window.undo = ()=>{ const s = JSON.parse(localStorage.getItem('kalah_state')||'null'); /* no-op here: visual button handled inside component */ toast('–ò—Å–ø–æ–ª—å–∑—É–π –æ—Ç–º–µ–Ω—É –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏'); };

      // Repo link
      document.getElementById('repoLink').href = window.location.origin + window.location.pathname;

      // Offline (simple)
      if('serviceWorker' in navigator){
        const sw = URL.createObjectURL(new Blob([`
          self.addEventListener('install', e=>{ e.waitUntil(caches.open('kalah-v1').then(c=>c.addAll(['./']))); self.skipWaiting(); });
          self.addEventListener('activate', e=> self.clients.claim());
          self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });
        `], {type:'text/javascript'}));
        navigator.serviceWorker.register(sw);
      }
    </script>
  </body>
</html>
