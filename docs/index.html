<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta name="color-scheme" content="dark light">
    <title>Kalah (Mancala) ‚Äî Web</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root{ --bg:#0b1220; --card:#0e1629; --muted:#9aa4b2; --ring:#334155; --txt:#e5e7eb;
             --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03) }
      @media (prefers-color-scheme: light){
        :root{ --bg:#f7fafc; --card:#fff; --txt:#0f172a; --muted:#475569; --ring:#cbd5e1 }
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        background:
          radial-gradient(1000px 700px at 10% -10%, rgba(34,197,94,.12), transparent 60%),
          radial-gradient(1000px 700px at 110% 20%, rgba(59,130,246,.12), transparent 60%),
          var(--bg);
        color:var(--txt); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
        -webkit-tap-highlight-color:transparent
      }
      .wrap{max-width:1080px;margin:0 auto;padding:clamp(12px,2.5vw,28px)}
      header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
      .title{font-size:clamp(22px,3.5vw,32px);font-weight:800;margin:0}
      .sub{margin:2px 0 0;color:var(--muted);font-size:clamp(12px,2.4vw,14px)}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      @media (min-width:900px){.grid{grid-template-columns:360px 1fr}}

      .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
      .card h3{margin:0 0 10px;font-size:16px}

      /* Board layout */
      .board{display:grid;grid-template-columns:90px 1fr 90px;gap:12px;align-items:center}
      @media (max-width:520px){.board{grid-template-columns:72px 1fr 72px}}
      .pits{display:grid;gap:12px}
      .row-gap{margin-top:18px}

      /* Stores */
      .store{
        min-height:100%;height:100%;border-radius:16px;border:1px solid var(--ring);
        display:flex;flex-direction:column;justify-content:center;align-items:center;
        background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
        box-shadow:var(--shadow)
      }
      .store .label{font-size:12px;color:var(--muted)}
      .store .val{font-size:clamp(18px,3.8vw,22px);font-weight:800;margin-top:6px}

      /* Round pits (real ‚Äúholes‚Äù) */
      .pit{
        position:relative;width:100%;aspect-ratio:1/1;border-radius:50%;
        border:1px solid var(--ring);
        background:
          radial-gradient(120% 120% at 50% 35%, rgba(0,0,0,.55), rgba(0,0,0,.15) 40%, rgba(255,255,255,.05) 65%, rgba(0,0,0,.25) 100%),
          linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
        box-shadow: inset 8px 10px 14px rgba(0,0,0,.45), inset -4px -6px 10px rgba(255,255,255,.08), var(--shadow);
        display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;
        transition:transform .08s ease, filter .2s ease, border-color .2s ease; touch-action:manipulation
      }
      .pit:active{transform:translateY(1px) scale(.99)}
      .pit.disabled{opacity:.45;cursor:not-allowed;filter:saturate(.7)}
      .pit .idx{position:absolute;top:6px;left:8px;font-size:11px;color:var(--muted)}
      .pit .val{font-weight:800;font-size:clamp(16px,3.5vw,20px)}

      /* Controls */
      .panel{display:flex;flex-wrap:wrap;gap:10px}
      .row{display:flex;gap:10px;align-items:center}
      .select,.input,button{appearance:none;background:var(--card);color:var(--txt);border:1px solid var(--ring);border-radius:12px;padding:10px 12px;font:inherit}
      button{cursor:pointer;box-shadow:var(--shadow)}
      .primary{background:linear-gradient(90deg,#16a34a,#22c55e);border-color:transparent;color:#051106;font-weight:800}
      .ghost{border-style:dashed}
      .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--ring);color:var(--muted);font-size:12px}
      .status{margin-top:8px;font-weight:600}

      /* Rules */
      details.rules{margin-top:10px}
      details.rules>summary{cursor:pointer;list-style:none;padding:8px 12px;border:1px dashed var(--ring);border-radius:12px;color:var(--muted)}
      details.rules>summary::-webkit-details-marker{display:none}
      details.rules .content{padding:10px 12px 2px;line-height:1.5}
      details.rules li{margin:6px 0}

      footer{margin-top:16px;color:var(--muted);font-size:13px}
      a.link{color:#60a5fa;text-decoration:none}

      .toast{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--ring);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);font-size:14px}
      @supports(padding:max(0px)){body{padding-bottom:max(0px,env(safe-area-inset-bottom))}}
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1 class="title">Kalah (Mancala)</h1>
          <p class="sub">–í–µ–±-–≤–µ—Ä—Å–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –ø–ª–∞–Ω—à–µ—Ç–∞ –∏ –ü–ö. –ü—Ä–∞–≤–∏–ª–∞ –ö–∞–ª–∞—Ö–∞: –±–æ–Ω—É—Å–Ω—ã–π —Ö–æ–¥ –∏ –∑–∞—Ö–≤–∞—Ç.</p>
        </div>
        <div class="row" role="group" aria-label="quick actions">
          <button id="newGame" class="primary">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
          <button id="undo" class="ghost">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
      </header>

      <div class="grid" aria-live="polite">
        <section class="card" aria-label="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã">
          <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <div class="panel">
            <label>–†–µ–∂–∏–º:
              <select id="aiMode" class="select">
                <option value="none">–ß–µ–ª–æ–≤–µ–∫ vs –ß–µ–ª–æ–≤–µ–∫</option>
                <option value="first">–ò–ò –∑–∞ P1 (–ø–µ—Ä–≤—ã–π)</option>
                <option value="second" selected>–ò–ò –∑–∞ P2 (–≤—Ç–æ—Ä–æ–π)</option>
                <option value="both">–ò–ò vs –ò–ò</option>
              </select>
            </label>
            <label>–ì–ª—É–±–∏–Ω–∞ –ò–ò:
              <input id="depth" class="input" type="number" min="1" max="10" value="6">
            </label>
            <label>–õ—É–Ω–æ–∫:
              <input id="pits" class="input" type="number" min="4" max="9" value="6">
            </label>
            <label>–ö–∞–º–Ω–µ–π:
              <input id="seeds" class="input" type="number" min="1" max="10" value="6">
            </label>
            <button id="apply" class="ghost">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="status" id="status">–ì–æ—Ç–æ–≤–æ</div>
          <div class="badge" id="badge">üü¢ –ò–¥—ë—Ç –∏–≥—Ä–∞</div>

          <details class="rules" open>
            <summary>–ü—Ä–∞–≤–∏–ª–∞ –∏ –∫–∞–∫ –∏–≥—Ä–∞—Ç—å</summary>
            <div class="content">
              <ol>
                <li><b>–ü–æ–ª–µ:</b> —É –∫–∞–∂–¥–æ–≥–æ –ø–æ <i>N</i> –ª—É–Ω–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 6). –°–ø—Ä–∞–≤–∞ ‚Äî –≤–∞—à —Å–∫–ª–∞–¥.</li>
                <li><b>–•–æ–¥:</b> –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–≤–æ—é –ª—É–Ω–∫—É. –ö–∞–º–Ω–∏ –∏–∑ –Ω–µ—ë —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –ø–æ –æ–¥–Ω–æ–π –≤ —Å–ª–µ–¥—É—é—â–∏–µ –ª—É–Ω–∫–∏ –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–∏, –ø—Ä–æ–ø—É—Å–∫–∞—è —Å–∫–ª–∞–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.</li>
                <li><b>–ë–æ–Ω—É—Å–Ω—ã–π —Ö–æ–¥:</b> –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–∞–º–µ–Ω—å –ø–æ–ø–∞–ª –≤ –≤–∞—à —Å–∫–ª–∞–¥ ‚Äî —Ö–æ–¥–∏—Ç–µ –µ—â—ë —Ä–∞–∑.</li>
                <li><b>–ó–∞—Ö–≤–∞—Ç:</b> –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–∞–º–µ–Ω—å –ø–æ–ø–∞–ª –≤ –≤–∞—à—É –ø—É—Å—Ç—É—é –ª—É–Ω–∫—É, –∞ –Ω–∞–ø—Ä–æ—Ç–∏–≤ –µ—Å—Ç—å –∫–∞–º–Ω–∏ ‚Äî –∑–∞–±–µ—Ä–∏—Ç–µ –∏—Ö –ø–ª—é—Å –≤–∞—à –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤ —Å–≤–æ–π —Å–∫–ª–∞–¥.</li>
                <li><b>–ö–æ–Ω–µ—Ü –∏–≥—Ä—ã:</b> –∫–æ–≥–¥–∞ –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ –æ–ø—É—Å—Ç–µ–ª–∞; –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∫–∞–º–Ω–∏ —É –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –∏–¥—É—Ç –≤ –µ—ë —Å–∫–ª–∞–¥. –ü–æ–±–µ–∂–¥–∞–µ—Ç —Ç–æ—Ç, —É –∫–æ–≥–æ –±–æ–ª—å—à–µ –≤ —Å–∫–ª–∞–¥–µ.</li>
              </ol>
            </div>
          </details>
        </section>

        <section class="card" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ">
          <div id="root"></div>
        </section>
      </div>

      <footer>
        –°–¥–µ–ª–∞–Ω–æ –Ω–∞ React (CDN). –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞.
        –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: <a class="link" href="https://github.com/DizzyZ7/kalah" target="_blank" rel="noopener">DizzyZ7/kalah</a>
      </footer>
    </div>

    <div id="toast" class="toast" hidden></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script type="module">
      const { useEffect, useState, useRef } = React;

      // utils
      const vibrate = ms => { try{ navigator.vibrate?.(ms) }catch(_){} };
      const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
      const load = (k,d)=> { try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch{ return d } };

      // core logic
      const makeInitial = (n=6, seeds=6) => ({ n, board: Array(2*n).fill(seeds).concat([0,0]), player:0, terminal:false });
      const pitsRange = (st,p)=> p===0 ? [...Array(st.n).keys()] : [...Array(st.n).keys()].map(i=>i+st.n);
      const isOwnPit = (st,idx,p=st.player)=> pitsRange(st,p).includes(idx);
      const oppositeIdx = (st,idx)=> 2*st.n - 1 - idx;
      const sideEmpty = (st,p)=> pitsRange(st,p).every(i=>st.board[i]===0);
      const clone = st => ({ n:st.n, board:[...st.board], player:st.player, terminal:st.terminal });
      const legalMoves = st => pitsRange(st,st.player).filter(i=> st.board[i]>0);
      const collectRemaining = st => { const s=clone(st), n=s.n;
        const s0=pitsRange(s,0).reduce((a,i)=>a+s.board[i],0);
        const s1=pitsRange(s,1).reduce((a,i)=>a+s.board[i],0);
        pitsRange(s,0).forEach(i=>s.board[i]=0);
        pitsRange(s,1).forEach(i=>s.board[i]=0);
        s.board[2*n]+=s0; s.board[2*n+1]+=s1; s.terminal=true; return s; };
      const applyMove = (st,move)=>{
        if(!legalMoves(st).includes(move)) throw new Error('invalid');
        const s=clone(st); let stones=s.board[move]; s.board[move]=0;
        const n=s.n, s0=2*n, s1=2*n+1; const own=s.player===0?s0:s1, opp=s.player===0?s1:s0;
        let idx=move;
        while(stones>0){ idx=(idx+1)%(2*n+2); if(idx===opp) continue; s.board[idx]++; stones--; }
        const extra=(idx===own);
        if(!extra && isOwnPit(s,idx) && s.board[idx]===1){
          const oi=oppositeIdx(s,idx); if(s.board[oi]>0){ const cap=s.board[oi]+1; s.board[oi]=0; s.board[idx]=0; s.board[own]+=cap; }
        }
        if(sideEmpty(s,0) || sideEmpty(s,1)) return [collectRemaining(s), extra];
        if(!extra) s.player=1-s.player;
        return [s, extra];
      };
      const score = st => [st.board[2*st.n], st.board[2*st.n+1]];
      const winner = st => { if(!st.terminal) return null; const [a,b]=score(st); return a===b?-1:(a>b?0:1); };

      // AI
      const evalState=(st,pov)=>{ const n=st.n; const my=st.board[2*n+pov], op=st.board[2*n+(1-pov)];
        const mySide=pitsRange(st,pov).reduce((a,i)=>a+st.board[i],0); return (my-op)*100 + Math.floor(0.2*mySide); };
      const minimax=(st,depth,pov,alpha=-1e9,beta=1e9)=>{
        if(depth===0||st.terminal) return [evalState(st,pov),null];
        const moves=legalMoves(st); if(!moves.length) return [evalState(st,pov),null];
        let bestMove=null;
        if(st.player===pov){
          let best=-1e9;
          for(const m of moves){ const [nx]=applyMove(st,m); const [v]=minimax(nx,depth-1,pov,alpha,beta);
            if(v>best){best=v;bestMove=m} alpha=Math.max(alpha,v); if(beta<=alpha) break; }
          return [best,bestMove];
        }else{
          let best=1e9;
          for(const m of moves){ const [nx]=applyMove(st,m); const [v]=minimax(nx,depth-1,pov,alpha,beta);
            if(v<best){best=v;bestMove=m} beta=Math.min(beta,v); if(beta<=alpha) break; }
          return [best,bestMove];
        }
      };
      const chooseBestMove=(st,depth=6)=>{ const [,m]=minimax(st,depth,st.player); return m ?? legalMoves(st)[0]; };

      // React UI
      function Pit({idx,label,value,disabled,onClick}){
        return React.createElement('button',{
          className:'pit'+(disabled?' disabled':''), onClick:disabled?undefined:onClick,
          'aria-label':`–õ—É–Ω–∫–∞ ${label}, –∫–∞–º–Ω–µ–π ${value}`, title:`–õ—É–Ω–∫–∞ ${label}`
        }, React.createElement('span',{className:'idx'},label),
           React.createElement('span',{className:'val'},value));
      }
      function Store({label,value}){
        return React.createElement('div',{className:'store',role:'img','aria-label':`${label}: ${value}`},
          React.createElement('div',{className:'label'},label),
          React.createElement('div',{className:'val'},value));
      }
      function Board({st,onPit}){
        const n=st.n; const legal=new Set(legalMoves(st));
        const top=st.board.slice(n,2*n);      // —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
        const bottom=st.board.slice(0,n);     // —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
        const [s0,s1]=score(st);
        const pitsStyle={gridTemplateColumns:`repeat(${n},minmax(0,1fr))`};

        return React.createElement(React.Fragment,null,
          React.createElement('div',{className:'board'},
            React.createElement(Store,{label:'–°–∫–ª–∞–¥ P2',value:s1}),
            React.createElement('div',{className:'pits',style:pitsStyle},
              top.map((v,i)=>{ const idx=n+i; const disabled=!legal.has(idx)||st.terminal;
                return React.createElement(Pit,{key:'t'+i,idx,label:(n-i),value:v,disabled,onClick:()=>onPit(idx)}); })
            ),
            React.createElement('div')
          ),
          React.createElement('div',{className:'board row-gap'},
            React.createElement('div'),
            React.createElement('div',{className:'pits',style:pitsStyle},
              bottom.map((v,i)=>{ const idx=i; const disabled=!legal.has(idx)||st.terminal;
                return React.createElement(Pit,{key:'b'+i,idx,label:(i+1),value:v,disabled,onClick:()=>onPit(idx)}); })
            ),
            React.createElement(Store,{label:'–°–∫–ª–∞–¥ P1',value:s0})
          )
        );
      }

      function useKalah(initial){
        const [conf,setConf]=useState(()=> load('kalah_conf',initial));
        const [st,setSt]=useState(()=> load('kalah_state', makeInitial(conf.n,conf.seeds)));
        const isHumanToMove = (s)=>{
          const ai=conf.ai; if(ai==='none') return true;
          if(ai==='both') return false;
          if(ai==='first'&&s.player===0) return false;
          if(ai==='second'&&s.player===1) return false;
          return true;
        };
        const step=(cur,i)=>{
          try{
            const [nxt,extra]=applyMove(cur,i);
            setSt(nxt); save('kalah_state',nxt); vibrate(10);
            if(!nxt.terminal){ if(!extra && !isHumanToMove(nxt)) think(nxt); if(extra && !isHumanToMove(nxt)) think(nxt); }
          }catch(_){}
        };
        const think=(cur)=>{
          setTimeout(()=>{
            const m=chooseBestMove(cur,conf.depth);
            const [nxt,extra]=applyMove(cur,m);
            setSt(nxt); save('kalah_state',nxt);
            if(!nxt.terminal && (extra || !isHumanToMove(nxt))) think(nxt);
          },80);
        };
        useEffect(()=>{ // —Å—Ç–∞—Ç—É—Å –≤ –ø–∞–Ω–µ–ª–∏
          const elS=document.getElementById('status');
          const elB=document.getElementById('badge');
          const setStatus=()=>{
            elS.textContent = st.terminal ? (winner(st)===-1?'–ù–∏—á—å—è':`–ü–æ–±–µ–¥–∏–ª –ò–≥—Ä–æ–∫ ${winner(st)+1}`) : `–•–æ–¥–∏—Ç –ò–≥—Ä–æ–∫ ${st.player+1}`;
            elB.textContent = st.terminal? 'üèÅ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞' : (st.player===0?'üü¢ –•–æ–¥ P1':'üîµ –•–æ–¥ P2');
          };
          setStatus();
        },[st]);
        useEffect(()=>{ if(!isHumanToMove(st)) think(st); },[]);
        return { st, setSt, conf, setConf, step, isHumanToMove };
      }

      function App(){
        const { st, conf, setConf, step, isHumanToMove } = useKalah({ ai:'second', depth:6, n:6, seeds:6 });
        // –≤–Ω–µ—à–Ω–∏–π UI-–∫–Ω–æ–ø–∫–∏
        useEffect(()=>{
          const elAi=document.getElementById('aiMode');
          const elDepth=document.getElementById('depth');
          const elPits=document.getElementById('pits');
          const elSeeds=document.getElementById('seeds');
          const elApply=document.getElementById('apply');
          const elNew=document.getElementById('newGame');
          const elUndo=document.getElementById('undo');

          const cfg=JSON.parse(localStorage.getItem('kalah_conf')||'{}');
          if(cfg.ai) elAi.value=cfg.ai; if(cfg.depth) elDepth.value=cfg.depth;
          if(cfg.n) elPits.value=cfg.n; if(cfg.seeds) elSeeds.value=cfg.seeds;

          elApply.onclick=()=>{
            localStorage.removeItem('kalah_state');
            const next={ ai:elAi.value, depth:+elDepth.value||6, n:+elPits.value||6, seeds:+elSeeds.value||6 };
            localStorage.setItem('kalah_conf', JSON.stringify(next));
            location.reload();
          };
          elNew.onclick=()=>{ localStorage.removeItem('kalah_state'); location.reload(); };
          elUndo.onclick=()=>{ /* —É–ø—Ä–æ—â—ë–Ω–Ω–æ */ };
          return ()=>{ elApply.onclick=elNew.onclick=elUndo.onclick=null; };
        },[]);

        return React.createElement(Board, { st, onPit:(i)=>{ if(isHumanToMove(st)) step(st,i); } });
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));

      // offline cache
      if('serviceWorker' in navigator){
        const sw = URL.createObjectURL(new Blob([`
          self.addEventListener('install', e=>{ e.waitUntil(caches.open('kalah-v1').then(c=>c.addAll(['./']))); self.skipWaiting(); });
          self.addEventListener('activate', e=> self.clients.claim());
          self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });
        `], {type:'text/javascript'}));
        navigator.serviceWorker.register(sw);
      }
    </script>
  </body>
</html>
